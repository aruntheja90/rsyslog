---

- name: Test Rsyslog role
  hosts: all

  pre_tasks:
    - name: Update apt
      become: yes
      apt:
        cache_valid_time: 1800
        update_cache: yes
      tags:
        - build

  roles:
    - role: sansible.rsyslog
      rsyslog:
        builtin_configs:
          application_logs:
            enabled: true
            logs:
              - path: "/var/log/some_log.log"
          auth_logs:
            enabled: true
          json_logs:
            enabled: true
            logs:
              - path: "/var/log/some_json_log.log"
                options:
                  type_tag: "application-logs-some-app"
          nginx_access_logs:
            enabled: true
            logs:
              - path: "/var/log/some_nginx_log.log"

  post_tasks:
    - name: Rsyslog should be installed
      command: rsyslogd -v
      tags:
        - assert

    - name: Rsyslog should already be started
      become: yes
      service:
        name: rsyslog
        state: started
      register: start_check
      failed_when: start_check.changed
      tags:
        - assert
